version: 2.1

orbs:
  git: opuscapita/git@volatile

jobs:
  init:
    docker:
      - image: opuscapita/minsk-core-machineuser-env:2
    steps:
      - run: circle_ci_add_env.sh \
          DOCKER_USER DOCKER_PASS \
          AZURE_USER AZURE_PASS \
          MINSK_CORE_AZURE_SUBSCRIPTION_ID MINSK_CORE_K8S_AZURE_RG MINSK_CORE_K8S_AZURE_NAME \
          MINSK_CORE_K8S_DEMO_DEPLOYMENTS_HOST \
          MINSK_CORE_SLACK_CI_WEBHOOK_URL

  build:
    docker:
      - image: opuscapita/minsk-core-cd:1
        auth:
          username: ${DOCKER_USER}
          password: ${DOCKER_PASS}
    working_directory: ~/build
    steps:
      - git/checkout-with-submodules
      - run:
          name: Extract params from commit message to environment
          command: |
            ./bin/parse-commit.sh "$(git show -s --format=%b ${CIRCLE_SHA1})"
      - run:
          name: Set required environment variables
          command: |
            slugify() { echo $1 | iconv -t ascii//TRANSLIT | sed -E s/[^a-zA-Z0-9]+/-/g | sed -E s/^-+\|-+$//g | tr A-Z a-z | cut -c1-53; }
            NAMESPACE=$( slugify "dev-${CIRCLE_PROJECT_REPONAME}-${BRANCH}" )
            SAFE_BRANCH=$( slugify "${BRANCH}" )
            echo "export NAMESPACE=${NAMESPACE}" >> ${BASH_ENV}
            echo "export SAFE_BRANCH=${SAFE_BRANCH}" >> ${BASH_ENV}
            echo "export IMAGE_PULL_SECRET_NAME=dockerhub" >> ${BASH_ENV}
      - run:
          name: Login to cluster
          command: |
            ./bin/cluster-login.sh \
              --azure-user="${AZURE_USER}" \
              --azure-pass="${AZURE_PASS}" \
              --subscription="${MINSK_CORE_AZURE_SUBSCRIPTION_ID}" \
              --azure-rg="${MINSK_CORE_K8S_AZURE_RG}" \
              --cluster-name="${MINSK_CORE_K8S_AZURE_NAME}"

      - run:
          name: Prepare namespace
          # setup a separate namespace in k8s for development installation,
          # and make sure imagePullSecret is present in this namespace before trying to deploy anything
          command: |
            ./bin/setup-dev-namespace.sh \
              --name="${NAMESPACE}" \
              --gh-repo-link="https://github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}" \
              --gh-branch="${BRANCH}" \
              --gh-commit="${COMMIT}" \
              --ci-build-url="${CIRCLE_BUILD_URL}"

            kubectl -n "${NAMESPACE}" create secret docker-registry dockerhub \
              --docker-server="https://index.docker.io/v1/" \
              --docker-username="${DOCKER_USER}" \
              --docker-password="${DOCKER_PASS}" \
              --dry-run -o yaml | kubectl apply -f -
      - run:
          name: Install/upgrade helm release
          command: |
            export GITHUB_PROJECT="${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}"
            export APPLICATION_URL_PATH="/${CIRCLE_PROJECT_REPONAME}/${SAFE_BRANCH}"
            export APPLICATION_URL="http://${MINSK_CORE_K8S_DEMO_DEPLOYMENTS_HOST}${APPLICATION_URL_PATH}"
            ./bin/helm-upgrade.sh \
              --chart-path=./helm/chart \
              --values-template=./helm/values.template.yaml \
              --namespace=${NAMESPACE} \
              --release-name=${NAMESPACE}
workflows:
  version: 2
  build-deployment-to-cloud:
    jobs:
      - init
      - build:
          requires:
            - init
          filters:
            tags:
              ignore: /.*/
